#include <stdio.h>
#include <stdlib.h>
#include <pwm.h>
#include <pwm12.h>
#include <p30F4012.h>
#include <math.h>
#include <dsp.h>

#define FCY 20000000 // 20 MIPS this is the amount of processes per second
#define FPWM 20000 // 20 kHz switching frequency
#define DEADTIME (unsigned int)(0.000002 * FCY) //dead time between triggers
#define _0_DEGREES 0x0000
#define _120_DEGREES 0x5555
#define _240_DEGREES 0xAAAA
#define _DES_FREQ 60 //target frequency
#define _DELTA_PHASE (unsigned int)(_DES_FREQ * 65536 / FPWM)

void InitMCPWM(void){
    TRISE = 0x0100; // ?PWM ?FLTA ????????????
    PTPER = (FCY/FPWM - 1) >> 1; // ????????????
    OVDCON = 0x0000; // ????PWM ???
    DTCON1 = DEADTIME; // ?????~2 us@ 20 MIPS ??????1:1
    PWMCON1 = 0x0077; // ??PWM ???????????
    PDC1 = PTPER; /* ?A ???0 ???????50% ?????????????????0 ?*/
    PDC2 = PTPER; // ?B ???0 ??
    PDC3 = PTPER; // ?C ???0 ??
    IFS2bits.PWMIF = 0; // ??PWM ????
    IEC2bits.PWMIE = 1; // ??PWM ??
    OVDCON = 0xFF00; // PWM ???PWM ??????
    PTCONbits.PTMOD = 2; // ????PWM ??
    return;
}

/*
 * 
 */
int main() {
    unsigned int Phase, Delta_Phase;
    unsigned int Phase_Offset1, Phase_Offset2, Phase_Offset3;
    int Multiplier1, Result1;
    int Multiplier2, Result2;
    int Multiplier3, Result3;
    Result1 = Result2 = Result3 = 0;
    int sinetable[] =
                    {0,205,411,617,823,1029,1235,1440,1646,1851,2057,2262,2468,2673,2878,3083,3288,3493,3698,3902,
4106,4311,4515,4718,4922,5125,5329,5532,5735,5937,6140,6342,6543,6745,6946,7148,7348,7549,7749,7949,
8148,8348,8547,8745,8943,9141,9339,9536,9733,9929,10125,10321,10516,10711,10905,11099,11293,11486,11678,11870,
12062,12253,12444,12634,12824,13013,13202,13390,13578,13765,13951,14137,14323,14508,14692,14876,15059,15241,15423,15605,
15785,15965,16145,16324,16502,16680,16856,17033,17208,17383,17557,17731,17903,18076,18247,18418,18587,18757,18925,19093,
19260,19426,19591,19756,19920,20083,20245,20407,20567,20727,20886,21045,21202,21358,21514,21669,21823,21976,22128,22280,
22430,22580,22729,22877,23024,23170,23315,23459,23602,23745,23886,24026,24166,24305,24442,24579,24714,24849,24983,25116,
25247,25378,25508,25636,25764,25891,26017,26141,26265,26387,26509,26629,26749,26867,26985,27101,27216,27330,27443,27555,
27666,27776,27884,27992,28099,28204,28308,28411,28513,28614,28714,28812,28910,29006,29102,29196,29288,29380,29471,29560,
29648,29735,29821,29906,29990,30072,30153,30233,30312,30390,30466,30541,30615,30688,30759,30830,30899,30967,31034,31099,
31163,31226,31288,31349,31408,31466,31523,31578,31633,31686,31738,31788,31837,31886,31932,31978,32022,32065,32107,32147,
32187,32225,32261,32297,32331,32364,32395,32425,32454,32482,32509,32534,32558,32580,32602,32622,32640,32658,32674,32689,
32702,32715,32726,32735,32744,32751,32757,32761,32764,32766,32767,32766,32764,32761,32757,32751,32744,32735,32726,32715,
32702,32689,32674,32658,32640,32622,32602,32580,32558,32534,32509,32482,32454,32425,32395,32364,32331,32297,32261,32225,
32187,32147,32107,32065,32022,31978,31932,31886,31837,31788,31738,31686,31633,31578,31523,31466,31408,31349,31288,31226,
31163,31099,31034,30967,30899,30830,30759,30688,30615,30541,30466,30390,30312,30233,30153,30072,29990,29906,29821,29735,
29648,29560,29471,29380,29288,29196,29102,29006,28910,28812,28714,28614,28513,28411,28308,28204,28099,27992,27884,27776,
27666,27555,27443,27330,27216,27101,26985,26867,26749,26629,26509,26387,26265,26141,26017,25891,25764,25636,25508,25378,
25247,25116,24983,24849,24714,24579,24442,24305,24166,24026,23886,23745,23602,23459,23315,23170,23024,22877,22729,22580,
22430,22280,22128,21976,21823,21669,21514,21358,21202,21045,20886,20727,20567,20407,20245,20083,19920,19756,19591,19426,
19260,19093,18925,18757,18587,18418,18247,18076,17903,17731,17557,17383,17208,17033,16856,16680,16502,16324,16145,15965,
15785,15605,15423,15241,15059,14876,14692,14508,14323,14137,13951,13765,13578,13390,13202,13013,12824,12634,12444,12253,
12062,11870,11678,11486,11293,11099,10905,10711,10516,10321,10125,9929,9733,9536,9339,9141,8943,8745,8547,8348,
8148,7949,7749,7549,7348,7148,6946,6745,6543,6342,6140,5937,5735,5532,5329,5125,4922,4718,4515,4311,
4106,3902,3698,3493,3288,3083,2878,2673,2468,2262,2057,1851,1646,1440,1235,1029,823,617,411,205,
0,-206,-412,-618,-824,-1030,-1236,-1441,-1647,-1852,-2058,-2263,-2469,-2674,-2879,-3084,-3289,-3494,-3699,-3903,
-4107,-4312,-4516,-4719,-4923,-5126,-5330,-5533,-5736,-5938,-6141,-6343,-6544,-6746,-6947,-7149,-7349,-7550,-7750,-7950,
-8149,-8349,-8548,-8746,-8944,-9142,-9340,-9537,-9734,-9930,-10126,-10322,-10517,-10712,-10906,-11100,-11294,-11487,-11679,-11871,
-12063,-12254,-12445,-12635,-12825,-13014,-13203,-13391,-13579,-13766,-13952,-14138,-14324,-14509,-14693,-14877,-15060,-15242,-15424,-15606,
-15786,-15966,-16146,-16325,-16503,-16681,-16857,-17034,-17209,-17384,-17558,-17732,-17904,-18077,-18248,-18419,-18588,-18758,-18926,-19094,
-19261,-19427,-19592,-19757,-19921,-20084,-20246,-20408,-20568,-20728,-20887,-21046,-21203,-21359,-21515,-21670,-21824,-21977,-22129,-22281,
-22431,-22581,-22730,-22878,-23025,-23171,-23316,-23460,-23603,-23746,-23887,-24027,-24167,-24306,-24443,-24580,-24715,-24850,-24984,-25117,
-25248,-25379,-25509,-25637,-25765,-25892,-26018,-26142,-26266,-26388,-26510,-26630,-26750,-26868,-26986,-27102,-27217,-27331,-27444,-27556,
-27667,-27777,-27885,-27993,-28100,-28205,-28309,-28412,-28514,-28615,-28715,-28813,-28911,-29007,-29103,-29197,-29289,-29381,-29472,-29561,
-29649,-29736,-29822,-29907,-29991,-30073,-30154,-30234,-30313,-30391,-30467,-30542,-30616,-30689,-30760,-30831,-30900,-30968,-31035,-31100,
-31164,-31227,-31289,-31350,-31409,-31467,-31524,-31579,-31634,-31687,-31739,-31789,-31838,-31887,-31933,-31979,-32023,-32066,-32108,-32148,
-32188,-32226,-32262,-32298,-32332,-32365,-32396,-32426,-32455,-32483,-32510,-32535,-32559,-32581,-32603,-32623,-32641,-32659,-32675,-32690,
-32703,-32716,-32727,-32736,-32745,-32752,-32758,-32762,-32765,-32767,-32768,-32767,-32765,-32762,-32758,-32752,-32745,-32736,-32727,-32716,
-32703,-32690,-32675,-32659,-32641,-32623,-32603,-32581,-32559,-32535,-32510,-32483,-32455,-32426,-32396,-32365,-32332,-32298,-32262,-32226,
-32188,-32148,-32108,-32066,-32023,-31979,-31933,-31887,-31838,-31789,-31739,-31687,-31634,-31579,-31524,-31467,-31409,-31350,-31289,-31227,
-31164,-31100,-31035,-30968,-30900,-30831,-30760,-30689,-30616,-30542,-30467,-30391,-30313,-30234,-30154,-30073,-29991,-29907,-29822,-29736,
-29649,-29561,-29472,-29381,-29289,-29197,-29103,-29007,-28911,-28813,-28715,-28615,-28514,-28412,-28309,-28205,-28100,-27993,-27885,-27777,
-27667,-27556,-27444,-27331,-27217,-27102,-26986,-26868,-26750,-26630,-26510,-26388,-26266,-26142,-26018,-25892,-25765,-25637,-25509,-25379,
-25248,-25117,-24984,-24850,-24715,-24580,-24443,-24306,-24167,-24027,-23887,-23746,-23603,-23460,-23316,-23171,-23025,-22878,-22730,-22581,
-22431,-22281,-22129,-21977,-21824,-21670,-21515,-21359,-21203,-21046,-20887,-20728,-20568,-20408,-20246,-20084,-19921,-19757,-19592,-19427,
-19261,-19094,-18926,-18758,-18588,-18419,-18248,-18077,-17904,-17732,-17558,-17384,-17209,-17034,-16857,-16681,-16503,-16325,-16146,-15966,
-15786,-15606,-15424,-15242,-15060,-14877,-14693,-14509,-14324,-14138,-13952,-13766,-13579,-13391,-13203,-13014,-12825,-12635,-12445,-12254,
-12063,-11871,-11679,-11487,-11294,-11100,-10906,-10712,-10517,-10322,-10126,-9930,-9734,-9537,-9340,-9142,-8944,-8746,-8548,-8349,
-8149,-7950,-7750,-7550,-7349,-7149,-6947,-6746,-6544,-6343,-6141,-5938,-5736,-5533,-5330,-5126,-4923,-4719,-4516,-4312,
-4107,-3903,-3699,-3494,-3289,-3084,-2879,-2674,-2469,-2263,-2058,-1852,-1647,-1441,-1236,-1030,-824,-618,-412,-206
};

    
    Phase = 0; // ??Phase ??
    Delta_Phase = _DELTA_PHASE; // ?Phase ??????60Hz ?????
   
    Phase += Delta_Phase; // ?Delta_Phase ???Phase ???

    Phase_Offset1 = _0_DEGREES; // ?????????????
    Multiplier1 = sinetable[(Phase + Phase_Offset1) >> 10];// ??????
    Result1 = Multiplier1*PTPER;
    PDC1 = Result1 + PTPER;

    Phase_Offset2 = _120_DEGREES; // ?????????????
    Multiplier2 = sinetable[(Phase + Phase_Offset2) >> 10];// ?????
    Result2 = Multiplier2*PTPER;
    PDC2 = Result2 + PTPER;

    Phase_Offset3 = _240_DEGREES; // ?????????????
    Multiplier3 = sinetable[(Phase + Phase_Offset3) >> 10];// ?????
    Result3 = Multiplier3*PTPER;
    PDC3 = Result3 + PTPER;

    PTCONbits.PTEN = 1;

    return 0;
}

